{% extends "base_teacher.html" %}
{% block title %}Create Quiz{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
        <div class="bg-kas-dark-green p-8 text-white">
            <h2 class="text-3xl font-black">Create New Quiz</h2>
            <p class="text-white/70">Set the schedule and time limits for your assessment.</p>
        </div>

        <form id="quiz-form" class="p-8">
            <div class="flex flex-col gap-6 mb-8">
                <div>
                    <label class="block text-sm font-bold text-kas-dark-green mb-2">Quiz Title</label>
                    <input type="text" id="quiz-title" class="w-full px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-kas-light-brown outline-none transition" placeholder="e.g., Mid-Term Assessment" required>
                </div>

                <div>
                    <label class="block text-sm font-bold text-kas-dark-green mb-2">Subject</label>
                    <select id="quiz-subject" class="w-full px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-kas-light-brown outline-none transition" required>
                        <option value="">Select a subject...</option>
                        {% for subject in subjects %}
                            <option value="{{ subject.id }}" {% if selected_subject_id|string == subject.id|string %}selected{% endif %}>
                                {{ subject.name }} (Form {{ subject.form }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-kas-dark-green mb-2">Available From (Start Time)</label>
                        <input type="datetime-local" id="start-time" class="w-full px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-kas-light-brown outline-none transition" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-kas-dark-green mb-2">Available Until (End Time)</label>
                        <input type="datetime-local" id="end-time" class="w-full px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-kas-light-brown outline-none transition" required>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-kas-dark-green mb-2">Duration (Minutes)</label>
                    <input type="number" id="quiz-duration" value="20" min="1" class="w-full px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-kas-light-brown outline-none transition" required>
                </div>
            </div>

            <hr class="border-slate-100 mb-8">

            <h3 class="text-xl font-black text-kas-dark-green mb-6 flex items-center">
                <i class="fas fa-list-ol mr-2 text-kas-light-brown"></i> Questions
            </h3>
            
            <div id="questions-container" class="flex flex-col gap-8"></div>

            <div class="flex flex-col gap-4 mt-8">
                <button type="button" id="add-mcq-btn" class="w-full py-3 bg-slate-50 text-slate-700 rounded-xl font-bold border-2 border-dashed border-slate-200 hover:bg-blue-50 hover:border-blue-200 transition">
                    <i class="fas fa-check-circle mr-2 text-blue-600"></i> Add Multiple Choice
                </button>
                <button type="button" id="add-sa-btn" class="w-full py-3 bg-slate-50 text-slate-700 rounded-xl font-bold border-2 border-dashed border-slate-200 hover:bg-kas-light-brown/10 hover:border-kas-light-brown transition">
                    <i class="fas fa-keyboard mr-2 text-kas-light-brown"></i> Add Short Answer
                </button>
            </div>

            <div class="mt-12 pt-8 border-t border-slate-100 flex flex-col items-center gap-6">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="is-published" class="w-5 h-5 accent-kas-dark-green">
                    <label for="is-published" class="font-bold text-slate-600 text-sm uppercase tracking-wide">Publish Immediately</label>
                </div>
                <button type="submit" id="deploy-btn" class="w-full py-4 bg-kas-dark-green text-white rounded-2xl font-black uppercase shadow-lg hover:bg-kas-light-brown transition-all">
                    Schedule and Deploy Quiz
                </button>
            </div>
            <div id="message" class="mt-4 text-center font-bold"></div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let questionCounter = 0;

    // 1. Function to add a new question card
    function addQuestion(type) {
        questionCounter++;
        const container = document.getElementById('questions-container');
        const questionHtml = document.createElement('div');
        
        questionHtml.className = 'quiz-question-card bg-slate-50 rounded-2xl p-6 border-2 border-slate-100 relative mb-6 shadow-sm';
        questionHtml.setAttribute('data-question-id', questionCounter);
        questionHtml.setAttribute('data-question-type', type);

        let optionsHtml = (type === 'MCQ') ? `
            <div class="options-container flex flex-col gap-3 mt-4" data-question-id="${questionCounter}"></div>
            <button type="button" class="mt-4 text-xs font-bold text-blue-600 uppercase tracking-widest hover:text-blue-800" onclick="addOption(${questionCounter})">
                + Add Option
            </button>` : `<p class="text-slate-400 text-xs mt-2 italic">Short answer text box will be provided for students.</p>`;

        questionHtml.innerHTML = `
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-200">
                <span class="text-[10px] font-black uppercase text-kas-light-brown tracking-widest">Question #${questionCounter} â€” ${type}</span>
                <button type="button" onclick="this.closest('.quiz-question-card').remove()" class="text-slate-300 hover:text-red-500 transition">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="space-y-4">
                <textarea class="js-question-text w-full p-4 rounded-xl border-2 border-white outline-none focus:border-kas-light-brown shadow-sm transition" placeholder="Enter Question Text..." required></textarea>
                
                <div class="flex items-center gap-2">
                    <label class="text-xs font-bold text-slate-400 uppercase">Points:</label>
                    <input type="number" class="js-question-points w-20 p-2 rounded-lg border-2 border-white shadow-sm outline-none focus:border-kas-light-brown" value="1" min="1">
                </div>
                ${optionsHtml}
            </div>
        `;
        container.appendChild(questionHtml);
        if (type === 'MCQ') { 
            addOption(questionCounter); 
            addOption(questionCounter); 
        }
    }

    // 2. Function to add MCQ options
    function addOption(qId) {
        const container = document.querySelector(`.options-container[data-question-id="${qId}"]`);
        if(!container) return;
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 bg-white p-3 rounded-xl border border-slate-200 shadow-sm';
        div.innerHTML = `
            <input type="radio" name="correct-${qId}" class="js-is-correct w-4 h-4 accent-kas-dark-green" required title="Mark as correct answer">
            <input type="text" class="js-option-text flex-1 text-sm outline-none" placeholder="Option text..." required>
            <button type="button" onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(div);
    }

    // 3. Attach button listeners
    document.getElementById('add-mcq-btn').onclick = () => addQuestion('MCQ');
    document.getElementById('add-sa-btn').onclick = () => addQuestion('Short Answer');

    // 4. Form Submission Logic
    document.getElementById('quiz-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
            const questions = [];
            const questionCards = document.querySelectorAll('.quiz-question-card');
            
            if (questionCards.length === 0) {
                alert("Please add at least one question before deploying.");
                return;
            }

            // Loop through each question card
            for (const qCard of questionCards) {
                const qId = qCard.getAttribute('data-question-id');
                const type = qCard.getAttribute('data-question-type');
                
                const textField = qCard.querySelector('.js-question-text');
                const pointsField = qCard.querySelector('.js-question-points');

                if (!textField || !pointsField) {
                    throw new Error(`Fields missing for Question #${qId}. Please recreate the question.`);
                }

                const questionObj = {
                    text: textField.value,
                    type: type,
                    points: pointsField.value,
                    options: []
                };

                if (type === 'MCQ') {
                    const optInputs = qCard.querySelectorAll('.js-option-text');
                    const correctRadios = qCard.querySelectorAll('.js-is-correct');
                    let hasCorrect = false;

                    optInputs.forEach((input, i) => {
                        const isChecked = correctRadios[i].checked;
                        if (isChecked) hasCorrect = true;
                        questionObj.options.push({
                            text: input.value,
                            is_correct: isChecked
                        });
                    });

                    if (!hasCorrect) {
                        alert(`Please select a correct answer for Question #${qId}`);
                        return;
                    }
                }
                questions.push(questionObj);
            }

            // Safe check for Main Quiz Fields
            const elTitle = document.getElementById('quiz-title');
            const elSubject = document.getElementById('quiz-subject');
            const elStart = document.getElementById('start-time');
            const elEnd = document.getElementById('end-time');
            const elDuration = document.getElementById('quiz-duration');
            const elPublished = document.getElementById('is-published');

            if (!elTitle || !elSubject || !elStart || !elEnd || !elDuration) {
                throw new Error("One or more main quiz settings (Title, Subject, Times) are missing in the HTML.");
            }

            const payload = {
                title: elTitle.value,
                subject_id: elSubject.value,
                start_time: elStart.value,
                end_time: elEnd.value,
                duration_minutes: elDuration.value,
                is_published: elPublished.checked,
                questions: questions
            };

            // Send POST request
            const res = await fetch('/teacher/quizzes/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            if (result.success) {
                window.location.href = '/teacher/quizzes';
            } else {
                alert("Server Error: " + result.message);
            }

        } catch (err) {
            console.error("Critical Error:", err);
            alert("Error: " + err.message);
        }
    });
</script>
{% endblock %}
