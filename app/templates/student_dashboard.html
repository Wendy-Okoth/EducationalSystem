
{% extends "base_student.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<section id="contact-form" class="form-container">
    <h1> Welcome, {{ student.name if student else 'Student' }}ðŸ‘‹</h1>
</section>

<section id="contact-form" class="form-container">
    <div class="search-section my-4">
        <h3>Find Your Subjects</h3>
        <div class="input-group mb-3">
            <input type="text" id="subject-search" class="form-control" placeholder="Search for a subject..." aria-label="Search for a subject">
        </div>
        <div id="search-results" class="list-group">
        </div>
        <div id="add-subject-message" class="mt-2"></div>
    </div>
</section>

<section class="form-container">
    <div class="card">
        <div class="card-header">
            <h4>Subject Progress</h4>
        </div>
        <ul id="progress-list" class="list-group list-group-flush">
            </ul>
    </div>
</section>

<div class="modal fade" id="enrollmentKeyModal" tabindex="-1" aria-labelledby="enrollmentKeyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="enrollmentKeyModalLabel">Enroll in <span id="modal-subject-name"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please enter the enrollment key to access this subject's content.</p>
                <div class="mb-3">
                    <input type="text" class="form-control" id="enrollment-key-input" placeholder="Enter enrollment key">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="enroll-button">Enroll</button>
            </div>
        </div>
    </div>
</div>
<div id="edubot-container">
    <div id="chat-window">
        <div id="chat-header">
            <h3>EduBot</h3>
            <button id="close-chat-btn">&times;</button>
        </div>
        <div id="chat-log">
            <div class="chat-message bot-message">Hello there! I'm EduBot. I can provide tips for your assignments in various subjects. Just ask me and I'll answer straight away'.</div>
        </div>
        <div id="chat-input-container">
            <input type="text" id="chat-input" placeholder="Type a message...">
            <button id="send-chat-btn">Send</button>
        </div>
    </div>
    <button id="open-chat-btn">Chat with EduBot</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- Subject Search and Add Logic ---
        const searchInput = document.getElementById('subject-search');
        const searchResultsDiv = document.getElementById('search-results');
        const messageDiv = document.getElementById('add-subject-message');
        const enrollmentKeyModal = new bootstrap.Modal(document.getElementById('enrollmentKeyModal'));
        let selectedSubjectId = null;

        let debounceTimeout;

        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimeout);
            const query = this.value.trim();

            if (query.length === 0) {
                searchResultsDiv.innerHTML = '';
                return;
            }

            debounceTimeout = setTimeout(() => {
                fetch(`/student/search_subjects?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(subjects => {
                        searchResultsDiv.innerHTML = '';
                        if (subjects.length > 0) {
                            subjects.forEach(subject => {
                                const resultItem = document.createElement('div');
                                resultItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                                resultItem.innerHTML = `
                                    <span class="subject-name">${subject.name}</span>
                                    <button class="btn btn-primary btn-sm add-subject-btn" data-subject-id="${subject.id}" data-subject-name="${subject.name}">Add</button>
                                `;
                                searchResultsDiv.appendChild(resultItem);
                            });
                        } else {
                            searchResultsDiv.innerHTML = '<div class="list-group-item text-muted">No subjects found.</div>';
                        }
                    })
                    .catch(error => console.error('Error fetching search results:', error));
            }, 300);
        });

        searchResultsDiv.addEventListener('click', function(event) {
            const clickedElement = event.target;
            
            if (clickedElement.classList.contains('add-subject-btn')) {
                const subjectId = clickedElement.getAttribute('data-subject-id');
                const subjectName = clickedElement.getAttribute('data-subject-name');
                
                selectedSubjectId = subjectId;
                document.getElementById('modal-subject-name').textContent = subjectName;
                enrollmentKeyModal.show();
            }
        });

        document.getElementById('enroll-button').addEventListener('click', function() {
            const enrollmentKey = document.getElementById('enrollment-key-input').value.trim();

            if (!enrollmentKey) {
                alert('Please enter an enrollment key.');
                return;
            }

            fetch('/student/add_subject', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject_id: parseInt(selectedSubjectId),
                    enrollment_key: enrollmentKey
                })
            })
            .then(response => response.json())
            .then(data => {
                messageDiv.textContent = data.message;
                messageDiv.className = data.success ? 'mt-2 text-success' : 'mt-2 text-danger';
                if (data.success) {
                    window.location.reload(); 
                }
                enrollmentKeyModal.hide();
                document.getElementById('enrollment-key-input').value = '';
                searchInput.value = '';
                searchResultsDiv.innerHTML = '';
            })
            .catch(error => {
                console.error('Error adding subject:', error);
                messageDiv.textContent = 'Failed to enroll in subject.';
                messageDiv.className = 'mt-2 text-danger';
                enrollmentKeyModal.hide();
            });
        });

        // --- EduBot Chatbot Logic ---
        const chatContainer = document.getElementById("edubot-container");
        const openBtn = document.getElementById("open-chat-btn");
        const closeBtn = document.getElementById("close-chat-btn");
        const chatInput = document.getElementById("chat-input");
        const sendBtn = document.getElementById("send-chat-btn");
        const chatLog = document.getElementById("chat-log");

        openBtn.addEventListener("click", () => {
            chatContainer.classList.add("open");
        });

        closeBtn.addEventListener("click", () => {
            chatContainer.classList.remove("open");
        });

        function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (userMessage === "") return;

            const userMessageDiv = document.createElement("div");
            userMessageDiv.className = "chat-message user-message";
            userMessageDiv.textContent = userMessage;
            chatLog.appendChild(userMessageDiv);

            chatInput.value = "";
            chatLog.scrollTop = chatLog.scrollHeight;

            fetch('/edubot_chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage
                })
            })
            .then(response => response.json())
            .then(data => {
                const botMessageDiv = document.createElement("div");
                botMessageDiv.className = "chat-message bot-message";
                botMessageDiv.textContent = data.message;
                chatLog.appendChild(botMessageDiv);
                chatLog.scrollTop = chatLog.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                const errorMessageDiv = document.createElement("div");
                errorMessageDiv.className = "chat-message bot-message";
                errorMessageDiv.textContent = "Oops! Something went wrong. Please try again.";
                chatLog.appendChild(errorMessageDiv);
                chatLog.scrollTop = chatLog.scrollHeight;
            });
        }

        sendBtn.addEventListener("click", sendMessage);
        chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                sendMessage();
            }
        });

        // --- New Progress Bar Logic ---
        const progressList = document.getElementById('progress-list');

        fetch('/student/api/progress')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (Object.keys(data).length === 0) {
                    progressList.innerHTML = '<li class="list-group-item text-muted">No subjects to track progress.</li>';
                    return;
                }

                for (const subjectId in data) {
                    const progress = data[subjectId];
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';
                    listItem.innerHTML = `
                        <h5 class="mb-1">${progress.subject_name}</h5>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" 
                                style="width: ${progress.percentage}%;" 
                                aria-valuenow="${progress.percentage}" 
                                aria-valuemin="0" 
                                aria-valuemax="100">
                                ${progress.completed} / ${progress.total}
                            </div>
                        </div>
                        <small class="text-muted">${progress.percentage}% completed</small>
                    `;
                    progressList.appendChild(listItem);
                }
            })
            .catch(error => {
                console.error('Error fetching progress data:', error);
                progressList.innerHTML = '<li class="list-group-item text-danger">Error loading progress data.</li>';
            });
    });
</script>
{% endblock %}
