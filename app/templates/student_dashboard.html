
{% extends "base_student.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<section id="contact-form" class="form-container">
<h1> Welcome, {{ student.name if student else 'Student' }}ðŸ‘‹</h1>
</section>
  <div class="search-section my-4">
            <h3>Find Your Subjects</h3>
            <div class="input-group mb-3">
                <input type="text" id="subject-search" class="form-control" placeholder="Search for a subject..." aria-label="Search for a subject">
            </div>
            <div id="search-results" class="list-group">
                </div>
            <div id="add-subject-message" class="mt-2"></div>
        </div>

    </div>
 <div id="edubot-container">
        <div id="chat-window">
            <div id="chat-header">
                <h3>EduBot</h3>
                <button id="close-chat-btn">&times;</button>
            </div>
            <div id="chat-log">
                <div class="chat-message bot-message">Hello there! I'm EduBot. I can provide tips for your assignments in various subjects. Just ask me and I'll answer straight away'.</div>
            </div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Type a message...">
                <button id="send-chat-btn">Send</button>
            </div>
        </div>
        <button id="open-chat-btn">Chat with EduBot</button>
    </div>
{% endblock %}

{% block extra_js %}
 <script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- Subject Search and Add Logic ---
        const searchInput = document.getElementById('subject-search');
        const searchResultsDiv = document.getElementById('search-results');
        const messageDiv = document.getElementById('add-subject-message');

        let debounceTimeout;

        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimeout);
            const query = this.value.trim();

            if (query.length === 0) {
                searchResultsDiv.innerHTML = '';
                return;
            }

            debounceTimeout = setTimeout(() => {
                fetch(`/student/search_subjects?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(subjects => {
                        searchResultsDiv.innerHTML = '';
                        if (subjects.length > 0) {
                            subjects.forEach(subject => {
                                const resultItem = document.createElement('div');
                                resultItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                                resultItem.innerHTML = `
                                    <span class="subject-name" data-subject-id="${subject.id}">${subject.name}</span>
                                    <button class="btn btn-primary btn-sm add-subject-btn" data-subject-id="${subject.id}">Add</button>
                                `;
                                searchResultsDiv.appendChild(resultItem);
                            });
                        } else {
                            searchResultsDiv.innerHTML = '<div class="list-group-item text-muted">No subjects found.</div>';
                        }
                    })
                    .catch(error => console.error('Error fetching search results:', error));
            }, 300); // 300ms debounce
        });

        // Event listener to handle clicking a subject name from the results
        searchResultsDiv.addEventListener('click', function(event) {
            const clickedElement = event.target;
            
            // If the user clicked the subject name span
            if (clickedElement.classList.contains('subject-name')) {
                const subjectName = clickedElement.textContent.trim();
                
                // Set the search input field to the selected subject's name
                searchInput.value = subjectName;
                
                // Optionally, clear the search results after selection
                searchResultsDiv.innerHTML = '';
            }
            
            // If the user clicked the 'Add' button
            if (clickedElement.classList.contains('add-subject-btn')) {
                const subjectId = clickedElement.getAttribute('data-subject-id');
                fetch('/student/add_subject', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ subject_id: parseInt(subjectId) })
                })
                .then(response => response.json())
                .then(data => {
                    messageDiv.textContent = data.message;
                    messageDiv.className = data.success ? 'mt-2 text-success' : 'mt-2 text-danger';
                })
                .catch(error => {
                    console.error('Error adding subject:', error);
                    messageDiv.textContent = 'Failed to add subject.';
                    messageDiv.className = 'mt-2 text-danger';
                });
            }
        });

        // --- EduBot Chatbot Logic ---
        const chatContainer = document.getElementById("edubot-container");
        const openBtn = document.getElementById("open-chat-btn");
        const closeBtn = document.getElementById("close-chat-btn");
        const chatInput = document.getElementById("chat-input");
        const sendBtn = document.getElementById("send-chat-btn");
        const chatLog = document.getElementById("chat-log");

        // Function to open/close the chat window
        openBtn.addEventListener("click", () => {
            chatContainer.classList.add("open");
        });

        closeBtn.addEventListener("click", () => {
            chatContainer.classList.remove("open");
        });

        // Function to send a message
        function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (userMessage === "") return;

            // Display user message in chat log
            const userMessageDiv = document.createElement("div");
            userMessageDiv.className = "chat-message user-message";
            userMessageDiv.textContent = userMessage;
            chatLog.appendChild(userMessageDiv);

            chatInput.value = ""; // Clear input field
            chatLog.scrollTop = chatLog.scrollHeight; // Scroll to bottom

            // Send message to the Flask back-end
            fetch('/edubot_chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: userMessage })
            })
            .then(response => response.json())
            .then(data => {
                // Display bot's response
                const botMessageDiv = document.createElement("div");
                botMessageDiv.className = "chat-message bot-message";
                botMessageDiv.textContent = data.message;
                chatLog.appendChild(botMessageDiv);
                chatLog.scrollTop = chatLog.scrollHeight; // Scroll to bottom
            })
            .catch(error => {
                console.error('Error:', error);
                const errorMessageDiv = document.createElement("div");
                errorMessageDiv.className = "chat-message bot-message";
                errorMessageDiv.textContent = "Oops! Something went wrong. Please try again.";
                chatLog.appendChild(errorMessageDiv);
                chatLog.scrollTop = chatLog.scrollHeight;
            });
        }

        // Event listeners for sending a message
        sendBtn.addEventListener("click", sendMessage);
        chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                sendMessage();
            }
        });
    });
</script>
{% endblock %}
