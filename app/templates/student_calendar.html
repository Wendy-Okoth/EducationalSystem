{% extends "base_student.html" %}
{% block title %}Academic Calendar{% endblock %}
{% block page_title %}Academic Calendar{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    :root {
        --kas-green: #2E5B27;
        --kas-brown: #D4A76A;
    }

    /* Standard Calendar Styling to match Teacher view */
    .fc .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 800 !important;
        color: var(--kas-green);
        text-transform: uppercase;
    }

    .fc-theme-standard td, .fc-theme-standard th {
        border-color: #f1f5f9 !important;
    }

    /* Red Bracketed Deadline Styling */
    .deadline-event {
        background-color: transparent !important;
        border: none !important;
        color: #ef4444 !important; /* Red-500 */
        font-weight: 800 !important;
        font-size: 0.8rem !important;
    }

    .deadline-bracket {
        color: #ef4444;
        font-weight: 900;
        margin: 0 1px;
    }

    /* Regular Event Styling */
    .fc-event:not(.deadline-event) {
        border-radius: 6px !important;
        padding: 2px 5px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-slate-100 mb-8">
        <h2 class="text-3xl font-black text-kas-dark-green mb-6 flex items-center">
            <i class="fas fa-calendar-alt mr-3 text-kas-light-brown"></i> 
            My Academic Schedule
        </h2>
        <div id="calendar"></div>
    </div>

    <div class="bg-white rounded-3xl shadow-lg p-6 border border-slate-100">
        <h2 class="text-xl font-bold text-kas-dark-green mb-6 flex items-center">
            <span class="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center mr-3">
                <i class="fas fa-clock text-red-500 text-sm"></i>
            </span>
            Deadlines This Week
        </h2>
        
        <div id="upcoming-events" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="col-span-full text-center py-4">
                <div class="animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent text-kas-light-brown rounded-full"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            height: 'auto',
            events: '/student/api/calendar_events',
            
            // Custom Content Logic for Brackets
            eventContent: function(arg) {
                // Check if the event is a deadline (Assignments/Quizzes)
                const isDeadline = arg.event.extendedProps.type === 'assignment' || arg.event.title.toLowerCase().includes('due');
                
                if (isDeadline) {
                    let title = arg.event.title.replace('Due:', '').trim();
                    return {
                        html: `<div class="deadline-event">
                                <span class="deadline-bracket">[</span>${title}<span class="deadline-bracket">]</span>
                               </div>`
                    };
                }
                // Default rendering for other events (like classes)
                return { 
                    html: `<div class="p-1 font-bold">${arg.event.title}</div>` 
                };
            },

            eventClick: function(info) {
                if(info.event.extendedProps.description) {
                    alert(info.event.title + "\n\n" + info.event.extendedProps.description);
                }
            }
        });

        calendar.render();

        // Load "Due This Week" list
        fetch('/student/api/upcoming_events')
            .then(res => res.json())
            .then(events => {
                const container = document.getElementById('upcoming-events');
                if (events.length === 0) {
                    container.innerHTML = `<p class="col-span-full text-center text-slate-400 py-4 font-medium">No urgent deadlines this week!</p>`;
                    return;
                }

                container.innerHTML = events.map(event => `
                    <div class="p-4 bg-red-50/50 rounded-2xl border border-red-100 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-red-500 shadow-sm">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-kas-dark-green text-sm">${event.title}</h4>
                                <p class="text-[10px] uppercase font-bold text-slate-400">${event.time}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-black text-red-600 uppercase">
                                [${new Date(event.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}]
                            </p>
                        </div>
                    </div>
                `).join('');
            });
    });
</script>
{% endblock %}




